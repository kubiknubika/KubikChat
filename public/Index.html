<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KubikChat v8.0 Final</title>
    <style>
        /* –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨ */
        body { background-color: #111; color: #0f0; font-family: 'Consolas', monospace; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        header { width: 80%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #0f0; padding: 10px 0; }
        #room-badge { background: #007700; color: #fff; padding: 2px 8px; border-radius: 4px; margin-left: 10px; }
        #typing-indicator { font-style: italic; color: #888; height: 20px; width: 80%; text-align: left; }
        
        /* –ß–ê–¢ */
        #chat { width: 80%; flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 10px; scrollbar-width: thin; scrollbar-color: #0f0 #111; }
        
        /* –°–û–û–ë–©–ï–ù–ò–Ø */
        .message { margin-bottom: 8px; line-height: 1.4; word-wrap: break-word; }
        .timestamp { color: #555; font-size: 0.8em; margin-right: 8px; }
        .star { color: gold; margin-right: 3px; }
        
        /* –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π */
        .msg-system { color: #666; font-style: italic; }
        .msg-action { color: #f0f; font-style: italic; }
        .msg-private { color: #ff00ff; border-left: 3px solid #ff00ff; padding-left: 10px; }
        .msg-shout { color: #fff; background: #f00; padding: 5px; text-align: center; font-weight: bold; border: 1px solid #fff; }
        .msg-burn { border: 1px dashed orange; padding: 5px; color: orange; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .chat-img { max-width: 300px; max-height: 200px; border: 1px solid #0f0; border-radius: 5px; display: block; margin-top: 5px; }
        code { background: #222; padding: 2px 4px; color: #fa8; font-family: monospace; border-radius: 3px; }
        pre { background: #222; padding: 10px; border-left: 3px solid #0f0; overflow-x: auto; color: #ccc; }
        b { color: #fff; }

        /* –ò–ù–ü–£–¢ –ò –ö–ù–û–ü–ö–ò */
        .input-area { width: 80%; position: relative; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; }
        input[type="text"] { background: #222; border: 1px solid #0f0; color: white; padding: 10px; font-family: inherit; outline: none; width: 100%; }
        button { background: #007700; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        button:hover { background: #00aa00; }
        #upload-btn { width: 50px; background: #444; display: flex; align-items: center; justify-content: center; font-size: 1.2em; padding: 0; }

        /* –ü–û–î–°–ö–ê–ó–ö–ò */
        #suggestions { position: absolute; bottom: 100%; left: 0; width: 100%; background: #000; border: 1px solid #0f0; border-bottom: none; display: none; max-height: 150px; overflow-y: auto; z-index: 10; }
        .suggestion-item { padding: 5px 10px; cursor: pointer; color: #0f0; }
        .suggestion-item.selected { background: #004400; color: #fff; }
        .suggestion-desc { color: #666; font-size: 0.8em; float: right; }
                /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ */
        .file-link {
            display: inline-flex;
            align-items: center;
            background: #222;
            border: 1px solid #0ff;
            color: #0ff;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 5px;
            transition: all 0.2s;
        }
        .file-link:hover {
            background: #0ff;
            color: #000;
        }
        .file-icon { margin-right: 8px; font-size: 1.2em; }
    </style>
</head>
<body>
    <header>
        <div>KUBIK_CHAT <span id="room-badge">#general</span></div>
        <div id="status">Online</div>
    </header>

    <div id="chat"></div>
    <div id="typing-indicator"></div>

    <div class="input-area">
        <div id="suggestions"></div>
        <div class="controls">
            <input type="file" id="file-input" style="display: none;" onchange="uploadFile()">
            <button id="upload-btn" onclick="document.getElementById('file-input').click()" title="Send File">üìé</button>
            <input type="text" id="msg" placeholder="Type message... (Tab for commands)" autocomplete="off">
            <button onclick="processInput()">SEND</button>
        </div>
    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${protocol}//${window.location.host}/ws`);
        const beep = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"); 
        
        // --- CONFIG & STATE ---
        const DOM = {
            chat: document.getElementById('chat'),
            input: document.getElementById('msg'),
            fileInput: document.getElementById('file-input'),
            roomBadge: document.getElementById('room-badge'),
            statusBadge: document.getElementById('status'),
            typing: document.getElementById('typing-indicator'),
            suggestions: document.getElementById('suggestions'),
            uploadBtn: document.getElementById('upload-btn')
        };

        let typingTimer;

        // --- 1. MESSAGE STRATEGIES (RENDERERS) ---
        // –ü–∞—Ç—Ç–µ—Ä–Ω "–°—Ç—Ä–∞—Ç–µ–≥–∏—è". –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è.
        const MessageStrategies = {
            'system': (data, ctx) => {
                return `<div class="message msg-system">${ctx.time} >>> ${ctx.content}</div>`;
            },
            'action': (data, ctx) => {
                return `<div class="message msg-action">${ctx.time} ${ctx.stars} <span style="color:${ctx.color}">* ${data.username}</span> ${ctx.content}</div>`;
            },
            'private': (data, ctx) => {
                return `<div class="message msg-private">${ctx.time} ${ctx.stars} <span class="sender">[${data.username}]:</span> ${ctx.content}</div>`;
            },
            'shout': (data, ctx) => {
                return `<div class="message msg-shout">üì¢ ${ctx.content}</div>`;
            },
            'burn': (data, ctx) => {
                // Burn —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–π –ª–æ–≥–∏–∫–∏ (—Ç–∞–π–º–µ—Ä), –ø–æ—ç—Ç–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É
                const div = document.createElement('div');
                div.className = 'message msg-burn';
                const id = 'burn-' + Math.random().toString(36).substr(2, 9);
                div.id = id;
                
                let sec = data.stars; // –°–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –ø–æ–ª–µ stars
                const render = () => `üî• [SELF-DESTRUCT ${sec}s]<br>${ctx.time} <span style="color:${ctx.color}">[${data.username}]:</span> ${ctx.content}`;
                
                div.innerHTML = render();
                
                const timer = setInterval(() => {
                    sec--;
                    const el = document.getElementById(id);
                    if (!el) { clearInterval(timer); return; } // –ï—Å–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω
                    
                    if (sec <= 0) {
                        el.remove();
                        clearInterval(timer);
                    } else {
                        el.innerHTML = render();
                    }
                }, 1000);
                return div;
            },
            'default': (data, ctx) => {
                const style = data.is_mention ? 'background:#330000' : '';
                return `<div class="message" style="${style}">${ctx.time} ${ctx.stars} <span class="sender" style="color:${ctx.color}">[${data.username}]:</span> ${ctx.content}</div>`;
            }
        };

        // --- 2. CORE LOGIC ---

        function appendMessage(data) {
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–Ω–¥–µ—Ä–µ—Ä–æ–≤)
            const context = {
                time: formatTime(data.timestamp),
                content: processContent(data.text, data.type),
                color: stringToColor(data.username),
                stars: data.stars > 0 ? `<span class="star">[‚òÖ${data.stars}]</span>` : ""
            };

            // –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            const strategy = MessageStrategies[data.type] || MessageStrategies['default'];
            const result = strategy(data, context);

            // –†–µ–Ω–¥–µ—Ä
            if (typeof result === 'string') {
                DOM.chat.insertAdjacentHTML('beforeend', result);
            } else {
                DOM.chat.appendChild(result); // –ï—Å–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤–µ—Ä–Ω—É–ª–∞ DOM —ç–ª–µ–º–µ–Ω—Ç (–∫–∞–∫ burn)
            }

            DOM.chat.scrollTop = DOM.chat.scrollHeight;
        }

        // --- 3. SOCKET HANDLERS ---

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            if (data.type === 'typing') { showTyping(data.username); return; }
            if (data.room) DOM.roomBadge.innerText = data.room;
            if (data.online_count) DOM.statusBadge.innerText = "Online: " + data.online_count;
            
            appendMessage(data);
            
            if(document.hidden || data.is_mention) beep.play().catch(()=>{}); 
        };

        // --- 4. INPUT & COMMANDS ---

        DOM.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') processInput();
            // (–°—é–¥–∞ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ª–æ–≥–∏–∫—É —Å—Ç—Ä–µ–ª–æ–∫ –∏ —Ç–∞–±–∞ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –∫–æ–¥–∞)
        });

        DOM.input.addEventListener('input', () => {
            if (!typingTimer) {
                socket.send(JSON.stringify({ type: 'typing' }));
                typingTimer = setTimeout(() => typingTimer = null, 2000);
            }
        });

        function processInput() {
            const text = DOM.input.value.trim();
            if (!text) return;

            if (text.startsWith('/clear')) {
                DOM.chat.innerHTML = '';
            } else if (text.startsWith('/me ')) {
                send(text.substring(4), "action");
            } else {
                send(text, "msg");
            }
            DOM.input.value = '';
        }

        function send(text, type) {
            socket.send(JSON.stringify({ text, type }));
        }

        function uploadFile() {
            const file = DOM.fileInput.files[0];
            if (!file) return;

            DOM.uploadBtn.innerText = "‚è≥";
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => data.url ? send(data.url, "msg") : alert("Failed"))
                .catch(console.error)
                .finally(() => {
                    DOM.uploadBtn.innerText = "üìé";
                    DOM.fileInput.value = "";
                });
        }

        // --- 5. HELPERS ---

        function processContent(text, type) {
            if (type === 'system') return text;
            
            // 1. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (XSS –∑–∞—â–∏—Ç–∞)
            let safe = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // 2. –ü–†–û–í–ï–†–ö–ê –ù–ê –ö–ê–†–¢–ò–ù–ö–£ (Image)
            // –õ–æ–≤–∏—Ç: http://...jpg –ò–õ–ò /uploads/...jpg
            const imgRegex = /(https?:\/\/\S+|\/uploads\/\S+)\.(png|jpg|jpeg|gif|webp)$/i;
            if (safe.match(imgRegex)) {
                return `<img src="${safe}" class="chat-img" onclick="window.open(this.src)">`;
            }

            // 3. –ü–†–û–í–ï–†–ö–ê –ù–ê –§–ê–ô–õ (File Download)
            // –õ–æ–≤–∏—Ç –ª—é–±–æ–π –ø—É—Ç—å, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å /uploads/, –∫–æ—Ç–æ—Ä—ã–π –ù–ï –ø–æ–ø–∞–ª –≤ —É—Å–ª–æ–≤–∏–µ –≤—ã—à–µ (–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞)
            const fileRegex = /^(\/uploads\/\S+)$/i;
            if (safe.match(fileRegex)) {
                // –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ —Å—Å—ã–ª–∫–∏ (–æ–±—Ä–µ–∑–∞–µ–º timestamp –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
                const fileName = safe.split('/').pop(); 
                return `<a href="${safe}" target="_blank" class="file-link" download>
                            <span class="file-icon">üíæ</span> Download: ${fileName}
                        </a>`;
            }
            
            // 4. MARKDOWN (–ö–æ–¥, –ñ–∏—Ä–Ω—ã–π)
            return safe
                .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        }

        
        function formatTime(ts) {
            if (!ts) return "";
            const d = new Date(ts * 1000);
            const pad = (n) => n.toString().padStart(2, '0');
            return `<span class="timestamp">[${pad(d.getHours())}:${pad(d.getMinutes())}]</span>`;
        }

        function showTyping(user) {
            DOM.typing.innerText = `${user} is typing...`;
            if (DOM.typing.timeout) clearTimeout(DOM.typing.timeout);
            DOM.typing.timeout = setTimeout(() => DOM.typing.innerText = '', 3000);
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash % 360)}, 100%, 60%)`;
        }
    </script>
</body>
</html>